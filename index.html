<!DOCTYPE html>
<html>
<head>
    <title>SAMXI SMART DOOR PRO</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2ecc71">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
    <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
    <script>
        window.OneSignalDeferred = window.OneSignalDeferred || [];
        OneSignalDeferred.push(async function(OneSignal) {
            await OneSignal.init({
                appId: "a71c864f-2514-4798-b919-4511e0801b5a",
                serviceWorkerPath: "OneSignalSDKWorker.js",
                serviceWorkerParam: { scope: "/" },
                safari_web_id: "web.onesignal.auto.2a0b8f88-f61f-4cbf-954f-aff96911a546",
                notifyButton: { enable: true },
            });
            let savedID = localStorage.getItem("samxi_id");
            if(savedID) { OneSignal.login(savedID); OneSignal.sendTag("device_id", savedID); }
        });
    </script>
    <style>
        .modal-content button { width: 100%; height: 55px; margin: 10px 0; padding: 0; font-size: 1.1rem; border-radius: 12px; display: flex; align-items: center; justify-content: center; border: none; cursor: pointer; font-weight: bold; }
        body{font-family:sans-serif;text-align:center;background:#141414;color:white;margin:0;}
        .header{background:#1a1a1a;padding:15px;display:flex;justify-content:space-between;align-items:center;border-bottom:2px solid #2ecc71;}
        .led-group{display:flex; align-items:center; gap:12px;}
        .wifi-box{font-size:0.75rem; font-weight:bold; color:#888; display:flex; align-items:center; gap:4px; background:#222; padding:3px 12px; border-radius:15px; border:1px solid #333;}
        .sig-excellent{color:#00ff7f; border-color: #00ff7f;}
        .sig-good{color:#f1c40f; border-color: #f1c40f;}
        .sig-weak{color:#ff4d4d; border-color: #ff4d4d;}
        .led{height:15px;width:15px;border-radius:50%;background:#444;transition:0.3s;}
        .green{background:#00ff7f;box-shadow:0 0 10px #00ff7f;}
        .red{background:#ff4d4d;box-shadow:0 0 10px #ff4d4d;}
        .gear-icon{width:22px; height:22px; cursor:pointer; fill:#f1c40f; visibility:hidden;}
        .container{padding:15px;max-width:400px;margin:auto;}
        #id {font-size: 2rem; font-weight: bold; text-align: center; color: #2ecc71; border: 2px solid #333; background: #222;}
        input,select{width:100%;padding:15px;margin:10px 0;background:#2a2a2a;border:1px solid #333;color:white;border-radius:8px;}
        .status-box{background:#2a2a2a;margin:15px 0;padding:25px;border-radius:12px;font-size:1.6rem;color:#2ecc71;border:1px solid #333;font-weight:bold; position: relative; overflow: hidden;}
        .progress-container{position:absolute; bottom:0; left:0; width:100%; height:6px; background:#1a1a1a; display:none;}
        .progress-bar{height:100%; width:0%; background:#2ecc71; transition: linear;}
        .btn{width:100%;margin:10px 0;padding:20px;font-size:1.5rem;border:none;border-radius:12px;font-weight:bold;cursor:pointer;color:white;height: 70px; display: flex; align-items: center; justify-content: center;}
        .up{background:#2ecc71;} .stop{background:#e74c3c;} .down{background:#3498db;} .auto{background:#f1c40f;color:black;display:none;}
        .timer-lock{pointer-events:none; opacity:0.35 !important;}
        #modal, #hModal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.95);z-index:100; overflow-y: auto;}
        .modal-content{background:#1c1c1c; width:85%; max-width:350px; margin:30px auto; padding:25px; border-radius:20px; text-align:left; border:1px solid #333;}
        .exit-link {background:none; color:#FFFFFF !important; border:none; margin-top:30px; display:block; width:100%; font-weight:900; font-size:2rem; cursor:pointer; text-align: center;}
        #toast {visibility: hidden; min-width: 280px; color: #fff; text-align: center; border-radius: 12px; padding: 18px; position: fixed; z-index: 1000; left: 50%; bottom: 40px; transform: translateX(-50%); transition: 0.3s;}
        #toast.show {visibility: visible;}
    </style>
</head>
<body>
    <div class="header">
        <span>SAMXI SMART DOOR</span>
        <div class="led-group">
            <div id="wifiSig" class="wifi-box" style="display:none;">üì∂ <span id="rssiVal">--</span></div>
            <div id="led" class="led"></div>
            <svg id="gear" class="gear-icon" onclick="document.getElementById('modal').style.display='block'" viewBox="0 0 24 24">
                <path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03 -.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21 -.08.47.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/>
            </svg>
        </div>
    </div>

    <div class="container">
        <div id="pg1">
            <h2 style="color:#2ecc71;">LOGIN</h2>
            <div id="netStat" style="font-size: 0.9rem; color: #2ecc71; margin-bottom: 10px;">Checking Connection...</div>
            <input type="text" id="id" placeholder="PRODUCT ID" value="SAMXI_12345">
            <button onclick="connect()" class="btn up">NEXT</button>
        </div>

        <div id="pg2" style="display:none;">
            <div class="status-box">CONNECTED</div>
            <input type="password" id="entryPin" placeholder="ENTER 4-DIGIT PIN" maxlength="4" style="text-align:center; font-size:1.8rem; border:2px solid #f1c40f;">
            <button onclick="verifyPin()" class="btn down" style="color:black; background:#f1c40f;">UNLOCK DOOR</button>
        </div>

        <div id="pg3" style="display:none;">
            <div class="status-box" id="stat">
                CHECKING SENSOR...
                <div class="progress-container" id="pCont"><div class="progress-bar" id="pBar"></div></div>
            </div>
            <div id="lastUpdate" style="font-size: 0.8rem; color: #888; margin-top: -10px; margin-bottom: 10px;">Last sync: --:--</div>
            <button class="btn up" onclick="cmd('up', 'OPEN GATE')">OPEN DOOR</button>
            <button class="btn stop" onclick="cmd('stop', 'STOP GATE')">STOP</button>
            <button class="btn down" onclick="cmd('down', 'CLOSE GATE')">CLOSE DOOR</button>
            <button id="abtn" class="btn auto" onclick="startAuto()">AUTO CLOSE</button>
            <button class="btn" style="background:#444; height:50px; margin-top:20px;" onclick="openHistory()">VIEW ACTIVITY HISTORY</button>
        </div>
    </div>

    <div id="hModal">
        <div class="modal-content">
            <h2 style="color:#2ecc71; margin-top:0;">ACTIVITY HISTORY</h2>
            <ul id="logList" style="list-style:none; padding:0; max-height:200px; overflow-y:auto;"></ul>
            <hr style="border:0; border-top:1px solid #333; margin:20px 0;">
            <button onclick="fetchSecurityLogs()" style="width:100%; background:#d9534f; color:white; padding:15px; border:none; border-radius:12px; font-weight:bold;">üõ°Ô∏è UN-AUTHORIZED LOG</button>
            <div id="securityLogDisplay" style="margin-top:15px; max-height:250px; overflow-y:auto;"></div>
            <button onclick="clearHistory()" style="width:100%;background:#444;padding:10px;border:none;border-radius:8px;margin-top:20px;color:white;cursor:pointer;">CLEAR LOGS</button>
            <button onclick="document.getElementById('hModal').style.display='none'" class="exit-link">EXIT</button>
        </div>
    </div>

    <div id="toast"></div>

    <script>
        let client, dev, currentWait = 10, countdownTimer, lastMsgTime = Date.now();
        let isCountingDown = false, isStatusLocked = false, lastSensorStatus = "OFFLINE";
        let timerEditing = false, gateReminderTimer = null;
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

        function showToast(msg, type) {
            const x = document.getElementById("toast");
            x.innerText = msg; x.className = "show " + (type === 'error' ? 'toast-red' : 'toast-green');
            setTimeout(() => x.className = "", 3000);
        }

        function vibrateAlert(type) { if ("vibrate" in navigator) { type === 'opening' ? navigator.vibrate([500, 100, 500]) : navigator.vibrate(200); } }
        
        function showProgress(duration) {
            const cont = document.getElementById('pCont'); const bar = document.getElementById('pBar');
            cont.style.display = 'block'; bar.style.transition = 'none'; bar.style.width = '0%';
            setTimeout(() => { bar.style.transition = `width ${duration}s linear`; bar.style.width = '100%'; }, 50);
        }

        function cmd(type, logMsg) {
            if(isCountingDown && type !== 'auto') return;
            const s = document.getElementById('stat');
            let displayTxt = (type === 'up') ? "OPENING..." : (type === 'down') ? "CLOSING..." : "STOPPED";
            isStatusLocked = true;
            s.innerHTML = displayTxt + document.getElementById('pCont').outerHTML;
            showProgress(8);
            setTimeout(() => {
                isStatusLocked = false;
                s.innerHTML = (lastSensorStatus === "OPEN") ? "GATE OPENED" : (lastSensorStatus === "CLOSED") ? "GATE CLOSED" : "SYSTEM READY";
                s.innerHTML += document.getElementById('pCont').outerHTML;
            }, 8000);
            addLog(logMsg); send(type);
        }

        function addLog(msg) {
            let logs = JSON.parse(localStorage.getItem("samxi_logs") || "[]");
            logs.unshift({ date: new Date().toLocaleString(), msg: msg });
            if(logs.length > 50) logs.pop();
            localStorage.setItem("samxi_logs", JSON.stringify(logs));
        }

        function openHistory() {
            const list = document.getElementById('logList');
            let logs = JSON.parse(localStorage.getItem("samxi_logs") || "[]");
            list.innerHTML = logs.map(l => `<li style="padding:10px; border-bottom:1px solid #333;"><small>${l.date}</small><br><b>${l.msg}</b></li>`).join('');
            document.getElementById('hModal').style.display = 'block';
        }

        function clearHistory() {
            localStorage.setItem("samxi_logs", "[]");
            localStorage.setItem("samxi_log_clear_time", Math.floor(Date.now() / 1000));
            openHistory();
            document.getElementById("securityLogDisplay").innerHTML = "";
            showToast("Logs Cleared", "green");
        }

        function connect() {
            dev = document.getElementById('id').value.trim();
            localStorage.setItem("samxi_id", dev);
            client = new Paho.MQTT.Client("broker.hivemq.com", 8884, "cl_" + Math.random().toString(16).slice(2,8));
            
            client.onConnectionLost = () => {
                document.getElementById('led').className = "led red";
                document.getElementById('stat').innerHTML = `OFFLINE <button onclick="connect()" style="margin-top:10px; padding:5px; background:#f1c40f; border:none; border-radius:5px; cursor:pointer;">RECONNECT</button>` + document.getElementById('pCont').outerHTML;
            };

            client.onMessageArrived = (m) => {
                let p = m.payloadString; let s = document.getElementById('stat');
                lastMsgTime = Date.now();
                document.getElementById('led').className="led green";
                document.getElementById('lastUpdate').innerText = "Last sync: " + new Date().toLocaleTimeString();

                if (p === "OPEN" || p === "OPENING") {
                    if (lastSensorStatus !== "OPEN") { showToast("Door Opening!", "error"); vibrateAlert('opening'); addLog("Detected: GateOpened"); }
                    lastSensorStatus = "OPEN"; if(!isStatusLocked) { s.innerHTML = "GATE OPENED" + document.getElementById('pCont').outerHTML; s.style.backgroundColor = "#3a1e1e"; }
                } else if (p === "CLOSED") {
                    if (lastSensorStatus !== "CLOSED") { showToast("Door Closed", "green"); vibrateAlert('closed'); addLog("Detected: GateClosed"); }
                    lastSensorStatus = "CLOSED"; if(!isStatusLocked) { s.innerHTML = "GATE CLOSED" + document.getElementById('pCont').outerHTML; s.style.backgroundColor = "#1e3a1e"; }
                } else if (p === "PIN_OK") {
                    document.getElementById('pg2').style.display='none'; document.getElementById('pg3').style.display='block';
                    send("GET_STATE");
                } else if (p.startsWith("DATA|")) {
                    let d = p.split("|"); currentWait = parseInt(d[3]);
                    document.getElementById('abtn').style.display = (d[2]=="1") ? "block" : "none";
                    if(s.innerText.includes("CHECKING")) {
                        if(p.includes("OPEN")) { s.innerHTML = "GATE OPENED" + document.getElementById('pCont').outerHTML; s.style.backgroundColor = "#3a1e1e"; }
                        else { s.innerHTML = "GATE CLOSED" + document.getElementById('pCont').outerHTML; s.style.backgroundColor = "#1e3a1e"; }
                    }
                }
            };

            client.connect({ useSSL:true, onSuccess: () => { 
                client.subscribe("samxi/"+dev+"/state"); 
                document.getElementById('pg1').style.display='none'; document.getElementById('pg2').style.display='block';
                send("GET_STATE");
            }});
        }

        async function fetchSecurityLogs() {
    const appId = "a71c864f-2514-4798-b919-4511e0801b5a";
    const display = document.getElementById("securityLogDisplay");
    let restKey = localStorage.getItem("samxi_rest_key") || prompt("Please enter your OneSignal REST API Key:");
    
    if (restKey) localStorage.setItem("samxi_rest_key", restKey);
    else return;

    const clearTime = parseInt(localStorage.getItem("samxi_log_clear_time") || "0");
    display.innerHTML = "<p style='text-align:center; color:#888;'>Checking Records...</p>";

    try {
        const response = await fetch(`https://onesignal.com/api/v1/notifications?app_id=${appId}&limit=50`, {
            method: 'GET',
            headers: { 'Authorization': `Basic ${restKey}`, 'Content-Type': 'application/json' }
        });
        const data = await response.json();

        if (response.status === 401) {
            localStorage.removeItem("samxi_rest_key");
            display.innerHTML = "<p style='text-align:center; color:#ff4d4d;'>Invalid Key. Try again.</p>";
            return;
        }

        let html = "";
        if (data.notifications && data.notifications.length > 0) {
            data.notifications.forEach(notif => {
                let msg = notif.contents.en;
                let notifTime = notif.queued_at;

                // --- HANDSHAKE LOGIC ---
                // 1. HIDDEN: If triggered by Web App buttons (Handshake)
                if (msg.includes("via APP")) return;

                // 2. HIDDEN: Routine warnings
                if (msg.includes("still open")) return;

                // 3. HIDDEN: If notification is older than the last "Clear Logs" action
                if (notifTime <= clearTime) return;

                // 4. SHOW ONLY: Actual Sensor triggers (Unauthorized)
                if (msg.includes("ALERT") || msg.includes("SUCCESS")) {
                    let date = new Date(notifTime * 1000);
                    let timeStr = date.toLocaleString('en-GB', { timeZone: 'Asia/Colombo' });
                    let themeColor = msg.includes("OPENED") ? "#ff4d4d" : "#2ecc71";
                    let label = msg.includes("OPENED") ? "‚ö†Ô∏è UN-AUTHORIZED OPEN" : "‚úÖ SYSTEM CLOSE";
                    
                    html += `<div style="padding:10px; border-bottom:1px solid #333; background:#222; margin-bottom:5px; border-radius:8px; border-left: 5px solid ${themeColor};">
                        <small style="color:${themeColor}; font-weight:bold;">${label}</small><br>
                        <span style="color:#888; font-size:11px;">${timeStr}</span><br>
                        <strong style="color:#eee;">${msg}</strong>
                    </div>`;
                }
            });
        }
        display.innerHTML = html || "<p style='text-align:center; color:#2ecc71;'>No new unauthorized events.</p>";
    } catch (err) {
        display.innerHTML = "<p style='text-align:center; color:#ff4d4d;'>Connection Error.</p>";
    }
}
    </script>
</body>
</html>
