<!DOCTYPE html>
<html>
<head>
    <title>SAMXI SMART DOOR PRO</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2ecc71">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
    <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
    <script>
    window.OneSignalDeferred = window.OneSignalDeferred || [];
    OneSignalDeferred.push(async function(OneSignal) {
      await OneSignal.init({
        appId: "a71c864f-2514-4798-b919-4511e0801b5a",
        serviceWorkerPath: "OneSignalSDKWorker.js",
        serviceWorkerParam: { scope: "/" },
        safari_web_id: "web.onesignal.auto.2a0b8f88-f61f-4cbf-954f-aff96911a546",
        notifyButton: { enable: true },
      });
    });
    </script>
    <style>
        .modal-content button { width: 100%; height: 55px; margin: 10px 0; font-size: 1.1rem; border-radius: 12px; display: flex; align-items: center; justify-content: center; border: none; cursor: pointer; font-weight: bold; }
        body{font-family:sans-serif;text-align:center;background:#141414;color:white;margin:0;}
        .header{background:#1a1a1a;padding:15px;display:flex;justify-content:space-between;align-items:center;border-bottom:2px solid #2ecc71;}
        .led-group{display:flex; align-items:center; gap:12px;}
        .wifi-box{font-size:0.75rem; font-weight:bold; color:#888; display:flex; align-items:center; gap:4px; background:#222; padding:3px 12px; border-radius:15px; border:1px solid #333;}
        .led{height:15px;width:15px;border-radius:50%;background:#444;transition:0.3s;}
        .green{background:#00ff7f;box-shadow:0 0 10px #00ff7f;}
        .red{background:#ff4d4d;box-shadow:0 0 10px #ff4d4d;}
        .gear-icon{width:22px; height:22px; cursor:pointer; fill:#f1c40f; visibility:hidden;}
        .container{padding:15px;max-width:400px;margin:auto;}
        #id {font-size: 2rem; font-weight: bold; text-align: center; color: #2ecc71; border: 2px solid #333;}
        input,select{width:100%;padding:15px;margin:10px 0;background:#2a2a2a;border:1px solid #333;color:white;border-radius:8px;box-sizing:border-box;}
        .status-box{background:#2a2a2a;margin:15px 0;padding:25px;border-radius:12px;font-size:1.6rem;color:#2ecc71;border:1px solid #333;font-weight:bold; position: relative; overflow: hidden;}
        .progress-container{position:absolute; bottom:0; left:0; width:100%; height:6px; background:#1a1a1a; display:none;}
        .progress-bar{height:100%; width:0%; background:#2ecc71;}
        .net-status{font-size:0.9rem; margin-bottom:10px; padding:5px; border-radius:5px;}
        .online-bg{background:#1e3a1e; color:#00ff7f;}
        .offline-bg{background:#3a1e1e; color:#ff4d4d;}
        .alert-active{background:#ff4d4d !important; color:white !important; animation: blink 1s infinite;}
        @keyframes blink { 50% { opacity: 0.5; } }
        .btn{width:100%;margin:10px 0;padding:20px;font-size:1.5rem;border:none;border-radius:12px;font-weight:bold;cursor:pointer;color:white; height: 70px; display: flex; align-items: center; justify-content: center;}
        .up{background:#2ecc71;} .stop{background:#e74c3c;} .down{background:#3498db;} .auto{background:#f1c40f;color:black;display:none;}
        #modal, #hModal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.95);z-index:100; overflow-y: auto;}
        .modal-content{background:#1c1c1c; width:85%; max-width:350px; margin:30px auto; padding:25px; border-radius:20px; text-align:left; border:1px solid #333;}
        .exit-link {background:none; color:#FFFFFF !important; border:none; margin-top:30px; display:block; width:100%; font-weight:900; font-size:2rem; cursor:pointer; text-align: center;}
        #logList{list-style:none; padding:0; margin:0; max-height:350px; overflow-y:auto;}
        .log-item{padding:10px; border-bottom:1px solid #333; display:flex; flex-direction:column; font-size:0.85rem;}
        .log-date{color:#888; font-size:0.75rem;}
        .log-msg{color:#2ecc71; font-weight:bold; margin-top:3px;}
        #toast {visibility: hidden; min-width: 280px; color: #fff; text-align: center; border-radius: 12px; padding: 18px; position: fixed; z-index: 1000; left: 50%; bottom: 40px; transform: translateX(-50%); font-weight: bold; transition: 0.3s;}
        #toast.show {visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s;}
        .toast-red { background-color: #e74c3c; } .toast-green { background-color: #2ecc71; color: #141414 !important; }
        @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 40px; opacity: 1;} }
        @keyframes fadeout { from {bottom: 40px; opacity: 1;} to {bottom: 0; opacity: 0;} }
    </style>
</head>
<body>
    <div class="header">
        <span>SAMXI SMART DOOR</span>
        <div class="led-group">
            <div id="wifiSig" class="wifi-box" style="display:none;">üì∂ <span id="rssiVal">--</span></div>
            <div id="led" class="led"></div>
            <svg id="gear" class="gear-icon" onclick="document.getElementById('modal').style.display='block'" viewBox="0 0 24 24">
                <path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/>
            </svg>
        </div>
    </div>
    <div class="container">
        <div id="pg1">
            <h2 style="color:#2ecc71;">LOGIN</h2>
            <div id="netStat" class="net-status online-bg">Checking Connection...</div>
            <input type="text" id="id" placeholder="PRODUCT ID" value="SAMXI_12345">
            <button onclick="connect()" class="btn up">NEXT</button>
        </div>
        <div id="pg2" style="display:none;">
            <div class="status-box">CONNECTED</div>
            <input type="password" id="entryPin" placeholder="4-DIGIT PIN" maxlength="4" style="text-align:center; font-size:1.8rem;">
            <button onclick="verifyPin()" class="btn down" style="background:#f1c40f; color:black;">UNLOCK DOOR</button>
        </div>
        <div id="pg3" style="display:none;">
            <div class="status-box" id="stat"> READY <div class="progress-container" id="pCont"><div class="progress-bar" id="pBar"></div></div> </div>
            <div id="lastUpdate" style="font-size: 0.8rem; color: #888; margin-bottom: 10px;">Last sync: --:--</div>
            <button id="m1" class="btn up" onclick="cmd('up', 'OPEN GATE')">OPEN DOOR</button>
            <button id="m2" class="btn stop" onclick="cmd('stop', 'STOP GATE')">STOP</button>
            <button id="m3" class="btn down" onclick="cmd('down', 'CLOSE GATE')">CLOSE DOOR</button>
            <button id="abtn" class="btn auto" onclick="startAuto()">AUTO CLOSE</button>
            <button class="btn hist-btn" onclick="openHistory()">VIEW ACTIVITY HISTORY</button>
        </div>
    </div>

    <div id="modal">
        <div class="modal-content">
            <h2 style="color:#2ecc71;">SETTINGS</h2>
            <label>Auto Close Mode:</label>
            <select id="ae">
                <option value="1">ENABLED</option>
                <option value="0">DISABLED</option>
            </select>
            <label>Timer (seconds):</label>
            <input type="number" id="at" onfocus="timerEditing=true" onblur="timerEditing=false">
            <button onclick="saveSettings()" style="background:#2ecc71; color:black;">SAVE AUTO SETTINGS</button>
            <hr style="border:1px solid #333; margin:20px 0;">
            <label>New PIN:</label>
            <input type="password" id="newPin" placeholder="4 Digits" maxlength="4">
            <button onclick="updatePin()" style="background:#f1c40f; color:black;">UPDATE PIN</button>
            <button onclick="document.getElementById('modal').style.display='none'" class="exit-link">EXIT</button>
        </div>
    </div>

    <div id="hModal">
        <div class="modal-content">
            <h2 style="color:#2ecc71;">HISTORY</h2>
            <ul id="logList"></ul>
            <hr style="border:1px solid #333; margin:20px 0;">
            <button onclick="fetchSecurityLogs()" style="background:#d9534f; color:white;">üõ°Ô∏è UN-AUTHORIZED LOG</button>
            <div id="securityLogDisplay" style="margin-top:10px; max-height:200px; overflow-y:auto;"></div>
            <button onclick="clearHistory()" style="background:#444;">CLEAR ALL</button>
            <button onclick="document.getElementById('hModal').style.display='none'" class="exit-link">EXIT</button>
        </div>
    </div>
    <div id="toast"></div>

    <script>
        let client, dev, currentWait = 10, timerEditing = false, isCountingDown = false, isStatusLocked = false, lastSensorStatus = "OFFLINE";
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

        function showToast(m, t) { const x = document.getElementById("toast"); x.innerText = m; x.className = "show " + (t === 'error' ? 'toast-red' : 'toast-green'); setTimeout(()=>x.className="", 3000); }
        
        function send(c) { if(client && client.isConnected()){ let m = new Paho.MQTT.Message(c); m.destinationName = "samxi/"+dev+"/cmd"; client.send(m); } }

        function saveSettings() {
            let t = document.getElementById('at').value;
            let e = document.getElementById('ae').value;
            currentWait = t;
            send("CONFIG|" + t + "|" + e);
            document.getElementById('abtn').style.display = (e == "1") ? "block" : "none";
            showToast("AUTO SETTINGS SAVED", "green");
        }

        function updatePin() {
            let p = document.getElementById('newPin').value;
            if(p.length < 4) { alert("PIN must be 4 digits"); return; }
            send("SETPIN|" + p);
            showToast("PIN UPDATE SENT", "green");
        }

        function clearHistory() {
            if(!confirm("Delete all?")) return;
            localStorage.setItem("samxi_logs", "[]");
            localStorage.setItem("persistent_auth_logs", "[]");
            openHistory();
            document.getElementById("securityLogDisplay").innerHTML = "";
            showToast("CLEARED", "green");
        }

        function connect() {
            dev = document.getElementById('id').value.trim();
            if(!dev) return;
            localStorage.setItem("samxi_id", dev);
            client = new Paho.MQTT.Client("broker.hivemq.com", 8884, "cl_" + Math.random().toString(16).slice(2,8));
            client.onMessageArrived = (m) => {
                let p = m.payloadString;
                document.getElementById('led').className="led green";
                if(p.startsWith("DATA|")) {
                    let d = p.split("|");
                    if(!timerEditing) { 
                        document.getElementById('at').value = d[3]; 
                        document.getElementById('ae').value = d[2];
                        document.getElementById('abtn').style.display = (d[2]=="1") ? "block" : "none";
                        currentWait = d[3];
                    }
                }
                if(p === "PIN_OK") { document.getElementById('pg2').style.display='none'; document.getElementById('pg3').style.display='block'; document.getElementById('gear').style.visibility='visible'; send("GET_STATE"); }
                if(p === "WRONG_PIN") alert("Wrong PIN!");
                if(p === "OPEN" || p === "CLOSED") { lastSensorStatus = p; document.getElementById('stat').innerText = "GATE " + p; }
            };
            client.connect({useSSL:true, onSuccess:()=>{ document.getElementById('pg1').style.display='none'; document.getElementById('pg2').style.display='block'; send("GET_STATE"); }});
        }

        function verifyPin() { send("VERIFY|" + document.getElementById('entryPin').value); }
        function cmd(t, l) { send(t); addLog(l); }
        function addLog(m) { let logs = JSON.parse(localStorage.getItem("samxi_logs")||"[]"); logs.unshift({date:new Date().toLocaleString(), msg:m}); localStorage.setItem("samxi_logs", JSON.stringify(logs.slice(0,50))); }
        function openHistory() { let logs = JSON.parse(localStorage.getItem("samxi_logs")||"[]"); document.getElementById('logList').innerHTML = logs.map(l=>`<li class="log-item"><span>${l.date}</span><strong>${l.msg}</strong></li>`).join(''); document.getElementById('hModal').style.display='block'; }

        async function fetchSecurityLogs() {
            const appId = "a71c864f-2514-4798-b919-4511e0801b5a";
            let restKey = localStorage.getItem("samxi_rest_key");
            if (!restKey) { restKey = prompt("Enter REST Key:"); localStorage.setItem("samxi_rest_key", restKey); }
            try {
                const r = await fetch(`https://onesignal.com/api/v1/notifications?app_id=${appId}&limit=50`, { headers: { 'Authorization': `Basic ${restKey}` } });
                const d = await r.json();
                let logs = JSON.parse(localStorage.getItem("persistent_auth_logs") || "[]");
                d.notifications.forEach(n => {
                    if (!n.contents.en.includes("via APP") && !logs.some(l=>l.id===n.id)) {
                        logs.push({id:n.id, msg:n.contents.en, date:new Date(n.queued_at*1000).toLocaleString()});
                    }
                });
                localStorage.setItem("persistent_auth_logs", JSON.stringify(logs.slice(0,100)));
                document.getElementById("securityLogDisplay").innerHTML = logs.map(l=>`<div style="background:#222; margin:5px; padding:10px; border-left:4px solid red;">${l.date}<br>${l.msg}</div>`).join('');
            } catch(e) { alert("Fetch error"); }
        }

        window.onload = () => { if(localStorage.getItem("samxi_id")) document.getElementById('id').value = localStorage.getItem("samxi_id"); };
    </script>
</body>
</html>
