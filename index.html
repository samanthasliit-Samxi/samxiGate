<!DOCTYPE html>
<html>
<head>
    <title>SAMXI SMART DOOR PRO</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2ecc71">
   
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
    <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
   
    <script>
    window.OneSignalDeferred = window.OneSignalDeferred || [];
    OneSignalDeferred.push(async function(OneSignal) {
      await OneSignal.init({
        appId: "a71c864f-2514-4798-b919-4511e0801b5a",
        serviceWorkerPath: "OneSignalSDKWorker.js",
        serviceWorkerParam: { scope: "/" },
        safari_web_id: "web.onesignal.auto.2a0b8f88-f61f-4cbf-954f-aff96911a546",
        notifyButton: { enable: true },
      });
    });
    </script>

    <style>
        body{font-family:sans-serif;text-align:center;background:#141414;color:white;margin:0;}
        .header{background:#1a1a1a;padding:15px;display:flex;justify-content:space-between;align-items:center;border-bottom:2px solid #2ecc71;}
        .led-group{display:flex; align-items:center; gap:12px;}
        .wifi-box{font-size:0.75rem; font-weight:bold; color:#888; display:flex; align-items:center; gap:4px; background:#222; padding:3px 12px; border-radius:15px; border:1px solid #333; transition: 0.3s;}
        .led{height:15px;width:15px;border-radius:50%;background:#444;transition:0.3s;}
        .green{background:#00ff7f;box-shadow:0 0 10px #00ff7f;}
        .red{background:#ff4d4d;box-shadow:0 0 10px #ff4d4d;}
        .gear-icon{width:22px; height:22px; cursor:pointer; fill:#f1c40f; visibility:hidden;}
        .container{padding:15px;max-width:400px;margin:auto;}
        #id {font-size: 2rem; font-weight: bold; text-align: center; color: #2ecc71; border: 2px solid #333;}
        input,select{width:100%;padding:15px;margin:10px 0;background:#2a2a2a;border:1px solid #333;color:white;border-radius:8px;box-sizing:border-box;}
        .status-box{background:#2a2a2a;margin:15px 0;padding:25px;border-radius:12px;font-size:1.6rem;color:#2ecc71;border:1px solid #333;font-weight:bold; transition: 0.3s; position: relative; overflow: hidden;}
        .progress-container{position:absolute; bottom:0; left:0; width:100%; height:6px; background:#1a1a1a; display:none;}
        .progress-bar{height:100%; width:0%; background:#2ecc71; transition: linear;}
        .net-status{font-size:0.9rem; margin-bottom:10px; padding:5px; border-radius:5px;}
        .online-bg{background:#1e3a1e; color:#00ff7f;}
        .offline-bg{background:#3a1e1e; color:#ff4d4d;}
        .alert-active{background:#ff4d4d !important; color:white !important; animation: blink 1s infinite;}
        @keyframes blink { 50% { opacity: 0.5; } }
        .btn{width:100%;margin:10px 0;padding:20px;font-size:1.5rem;border:none;border-radius:12px;font-weight:bold;cursor:pointer;color:white;transition:transform 0.1s; height: 70px; display: flex; align-items: center; justify-content: center;}
        .btn:active{transform:scale(0.96);}
        .up{background:#2ecc71;}
        .stop{background:#e74c3c;}
        .down{background:#3498db;}
        .auto{background:#f1c40f;color:black;display:none;}
        .timer-lock{pointer-events:none; opacity:0.35 !important; filter: contrast(0.8);}
        .hist-btn{background:#444; font-size:1.1rem; height:50px; margin-top:20px; border:1px solid #555;}
        #modal, #hModal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.95);z-index:100; overflow-y: auto;}
        .modal-content{background:#1c1c1c; width:85%; max-width:350px; margin:30px auto; padding:25px; border-radius:20px; text-align:left; border:1px solid #333;}
        .exit-link {background:none; color:#FFFFFF !important; border:none; margin-top:30px; display:block; width:100%; font-weight:900; font-size:2rem; cursor:pointer; text-align: center;}
        #logList{list-style:none; padding:0; margin:0; max-height:300px; overflow-y:auto;}
        .log-item{padding:10px; border-bottom:1px solid #333; display:flex; flex-direction:column; font-size:0.85rem;}
        #toast {visibility: hidden; min-width: 280px; color: #fff; text-align: center; border-radius: 12px; padding: 18px; position: fixed; z-index: 1000; left: 50%; bottom: 40px; transform: translateX(-50%); font-weight: bold; transition: 0.3s;}
        #toast.show {visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s;}
        @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 40px; opacity: 1;} }
        @keyframes fadeout { from {bottom: 40px; opacity: 1;} to {bottom: 0; opacity: 0;} }
    </style>
</head>
<body>
    <div class="header">
        <span>SAMXI SMART DOOR</span>
        <div class="led-group">
            <div id="wifiSig" class="wifi-box" style="display:none;">üì∂ <span id="rssiVal">--</span></div>
            <div id="led" class="led"></div>
            <svg id="gear" class="gear-icon" onclick="document.getElementById('modal').style.display='block'" viewBox="0 0 24 24">
                <path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/>
            </svg>
        </div>
    </div>

    <div class="container">
        <div id="pg1">
            <h2 style="color:#2ecc71;">LOGIN</h2>
            <div id="netStat" class="net-status online-bg">System Ready</div>
            <input type="text" id="id" placeholder="PRODUCT ID" value="SAMXI_12345">
            <button onclick="connect()" class="btn up">NEXT</button>
        </div>

        <div id="pg2" style="display:none;">
            <div class="status-box">DEVICE CONNECTED</div>
            <input type="password" id="entryPin" placeholder="ENTER 4-DIGIT PIN" maxlength="4" style="text-align:center; font-size:1.8rem; border:2px solid #f1c40f;">
            <button onclick="verifyPin()" class="btn down" style="color:black; background:#f1c40f;">UNLOCK DOOR</button>
        </div>

        <div id="pg3" style="display:none;">
            <div class="status-box" id="stat">CHECKING SENSOR... 
                <div class="progress-container" id="pCont"><div class="progress-bar" id="pBar"></div></div> 
            </div>
            <div id="lastUpdate" style="font-size: 0.8rem; color: #888; margin-top: -10px; margin-bottom: 10px;">Last update: --:--</div>
            <button id="m1" class="btn up" onclick="cmd('up', 'OPEN GATE')">OPEN DOOR</button>
            <button id="m2" class="btn stop" onclick="cmd('stop', 'STOP GATE')">STOP</button>
            <button id="m3" class="btn down" onclick="cmd('down', 'CLOSE GATE')">CLOSE DOOR</button>
            <button id="abtn" class="btn auto" onclick="startAuto()">AUTO CLOSE</button>
            <button id="hbtn" class="btn hist-btn" onclick="openHistory()">VIEW ACTIVITY HISTORY</button>
        </div>
    </div>

    <div id="hModal">
        <div class="modal-content">
            <h2 style="color:#2ecc71;">ACTIVITY HISTORY</h2>
            <ul id="logList"></ul>
            <hr style="border:0; border-top:1px solid #333; margin:20px 0;">
            <button onclick="fetchSecurityLogs()" style="width:100%; background:#d9534f; color:white; padding:15px; border-radius:12px; font-weight:bold;">üõ°Ô∏è UN-AUTHORIZED LOG</button>
            <div id="securityLogDisplay" style="margin-top:15px; max-height:200px; overflow-y:auto;"></div>
            <button onclick="clearHistory()" style="width:100%; background:#444; color:white; padding:10px; border-radius:8px; margin-top:20px;">CLEAR LOGS</button>
            <button onclick="document.getElementById('hModal').style.display='none'" class="exit-link">EXIT</button>
        </div>
    </div>

    <div id="toast"></div>

    <script>
        let client, dev, wakeLock = null;
        let lastButtonPressTime = 0, lastMsgTime = Date.now(), isStatusLocked = false, lastSensorStatus = "OFFLINE";

        function connect() {
            dev = document.getElementById('id').value.trim();
            localStorage.setItem("samxi_id", dev);
            
            // Start MQTT Connection
            client = new Paho.MQTT.Client("broker.hivemq.com", 8884, "cl_" + Math.random().toString(16).slice(2,8));

            client.onMessageArrived = (m) => {
                let p = m.payloadString;
                let s = document.getElementById('stat');
                lastMsgTime = Date.now();
                document.getElementById('led').className = "led green";

                // MOVE FROM LOGIN TO PIN PAGE ONCE SERVER RESPONDS
                if (document.getElementById('pg1').style.display !== 'none') {
                    document.getElementById('pg1').style.display = 'none';
                    document.getElementById('pg2').style.display = 'block';
                }

                if (p === "PIN_OK") {
                    document.getElementById('pg2').style.display = 'none';
                    document.getElementById('pg3').style.display = 'block';
                    document.getElementById('gear').style.visibility = 'visible';
                } else if (p === "WRONG_PIN") {
                    alert("Incorrect PIN!");
                } else if (p === "OPEN" || p === "CLOSED") {
                    lastSensorStatus = p;
                    if(!isStatusLocked) {
                        s.innerHTML = "GATE " + p + document.getElementById('pCont').outerHTML;
                        s.style.backgroundColor = (p === "OPEN") ? "#3a1e1e" : "#1e3a1e";
                    }
                }
            };

            client.connect({
                useSSL: true, timeout: 5,
                onSuccess: () => {
                    client.subscribe("samxi/" + dev + "/state");
                    send("GET_STATE");
                    // Force move to PIN page if connection is successful
                    document.getElementById('pg1').style.display = 'none';
                    document.getElementById('pg2').style.display = 'block';
                },
                onFailure: () => { alert("Connection Failed. Check Internet."); }
            });
        }

        function verifyPin() {
            let pin = document.getElementById('entryPin').value;
            if(pin.length < 4) { alert("Enter 4 digits"); return; }
            send("VERIFY|" + pin);
        }

        function cmd(type, logMsg) {
            lastButtonPressTime = Math.floor(Date.now() / 1000);
            isStatusLocked = true;
            document.getElementById('stat').innerHTML = "WORKING..." + document.getElementById('pCont').outerHTML;
            send(type);
            setTimeout(() => { isStatusLocked = false; }, 5000);
        }

        function send(c) {
            if (client && client.isConnected()) {
                let m = new Paho.MQTT.Message(c);
                m.destinationName = "samxi/" + dev + "/cmd";
                client.send(m);
            }
        }

        async function fetchSecurityLogs() {
            const appId = "a71c864f-2514-4798-b919-4511e0801b5a";
            const restKey = localStorage.getItem("samxi_rest_key") || prompt("Enter OneSignal REST API Key:");
            if (restKey) localStorage.setItem("samxi_rest_key", restKey);

            try {
                const response = await fetch(`https://onesignal.com/api/v1/notifications?app_id=${appId}&limit=50`, {
                    headers: {'Authorization': `Basic ${restKey}`, 'Content-Type': 'application/json'}
                });
                const data = await response.json();
                let html = "";
                data.notifications.forEach(n => {
                    let msg = n.contents.en;
                    if (msg.includes("via APP") || (Math.abs(n.queued_at - lastButtonPressTime) < 30)) return;
                    html += `<div style="padding:10px; border-bottom:1px solid #333;">${msg}</div>`;
                });
                document.getElementById("securityLogDisplay").innerHTML = html || "No events";
            } catch (e) { console.log(e); }
        }

        function clearHistory() {
            localStorage.setItem("samxi_logs", "[]");
            localStorage.setItem("samxi_log_clear_time", Math.floor(Date.now() / 1000));
            document.getElementById("securityLogDisplay").innerHTML = "Cleared";
        }
    </script>
</body>
</html>
