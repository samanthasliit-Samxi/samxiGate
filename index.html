<!DOCTYPE html>
<html>
<head>
    <title>SAMXI SMART DOOR PRO</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2ecc71">
   
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
    <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
   
    <script>
    window.OneSignalDeferred = window.OneSignalDeferred || [];
    OneSignalDeferred.push(async function(OneSignal) {
      await OneSignal.init({
        appId: "a71c864f-2514-4798-b919-4511e0801b5a",
       serviceWorkerPath: "OneSignalSDKWorker.js",
        serviceWorkerParam: { scope: "/" },
        safari_web_id: "web.onesignal.auto.2a0b8f88-f61f-4cbf-954f-aff96911a546",
        notifyButton: { enable: true },
      });

      OneSignal.Notifications.addEventListener("permissionChange", function(permission) {
          if (permission) {
              let savedID = localStorage.getItem("samxi_id");
              if(savedID) {
                  OneSignal.login(savedID);
                  OneSignal.sendTag("device_id", savedID);
              }
          }
      });
     
      let savedID = localStorage.getItem("samxi_id");
      if(savedID && OneSignal.Notifications.permission) {
          OneSignal.login(savedID);
          OneSignal.sendTag("device_id", savedID);
      }
    });
    </script>

    <style>
.modal-content button {
    width: 100%;
    height: 55px;
    margin: 10px 0;
    padding: 0;
    font-size: 1.1rem;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    border: none;
    cursor: pointer;
    font-weight: bold;
}
        body{font-family:sans-serif;text-align:center;background:#141414;color:white;margin:0;}
        .header{background:#1a1a1a;padding:15px;display:flex;justify-content:space-between;align-items:center;border-bottom:2px solid #2ecc71;}
        .led-group{display:flex; align-items:center; gap:12px;}
        .wifi-box{font-size:0.75rem; font-weight:bold; color:#888; display:flex; align-items:center; gap:4px; background:#222; padding:3px 12px; border-radius:15px; border:1px solid #333; transition: 0.3s;}
        .sig-excellent{color:#00ff7f; border-color: #00ff7f;}
        .sig-good{color:#f1c40f; border-color: #f1c40f;}
        .sig-weak{color:#ff4d4d; border-color: #ff4d4d;}
        .led{height:15px;width:15px;border-radius:50%;background:#444;transition:0.3s;}
        .green{background:#00ff7f;box-shadow:0 0 10px #00ff7f;}
        .red{background:#ff4d4d;box-shadow:0 0 10px #ff4d4d;}
        .gear-icon{width:22px; height:22px; cursor:pointer; fill:#f1c40f; visibility:hidden;}
        .container{padding:15px;max-width:400px;margin:auto;}
        #id {font-size: 2rem; font-weight: bold; text-align: center; color: #2ecc71; border: 2px solid #333;}
        input,select{width:100%;padding:15px;margin:10px 0;background:#2a2a2a;border:1px solid #333;color:white;border-radius:8px;box-sizing:border-box;}
        .status-box{background:#2a2a2a;margin:15px 0;padding:25px;border-radius:12px;font-size:1.6rem;color:#2ecc71;border:1px solid #333;font-weight:bold; transition: 0.3s; position: relative; overflow: hidden;}
        .progress-container{position:absolute; bottom:0; left:0; width:100%; height:6px; background:#1a1a1a; display:none;}
        .progress-bar{height:100%; width:0%; background:#2ecc71; transition: linear;}
        .net-status{font-size:0.9rem; margin-bottom:10px; padding:5px; border-radius:5px;}
        .online-bg{background:#1e3a1e; color:#00ff7f;}
        .offline-bg{background:#3a1e1e; color:#ff4d4d;}
        .alert-active{background:#ff4d4d !important; color:white !important; animation: blink 1s infinite;}
        @keyframes blink { 50% { opacity: 0.5; } }
        .btn{width:100%;margin:10px 0;padding:20px;font-size:1.5rem;border:none;border-radius:12px;font-weight:bold;cursor:pointer;color:white;transition:transform 0.1s; height: 70px; display: flex; align-items: center; justify-content: center;}
        .btn:active{transform:scale(0.96);}
        .up{background:#2ecc71;}
        .stop{background:#e74c3c;}
        .down{background:#3498db;}
        .auto{background:#f1c40f;color:black;display:none;}
        .timer-lock{pointer-events:none; opacity:0.35 !important; filter: contrast(0.8);}
        .hist-btn{background:#444; font-size:1.1rem; height:50px; margin-top:20px; border:1px solid #555;}
        #modal, #hModal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.95);z-index:100; overflow-y: auto;}
        .modal-content{background:#1c1c1c; width:85%; max-width:350px; margin:30px auto; padding:25px; border-radius:20px; text-align:left; border:1px solid #333; padding-bottom: 50px;}
        .exit-link {background:none; color:#FFFFFF !important; border:none; margin-top:30px; display:block; width:100%; font-weight:900; font-size:2rem; cursor:pointer; text-shadow:0 0 10px #ffffff, 0 0 20px #ffffff; text-align: center;}
        #logList{list-style:none; padding:0; margin:0; max-height:350px; overflow-y:auto;}
        .log-item{padding:10px; border-bottom:1px solid #333; display:flex; flex-direction:column; font-size:0.85rem;}
        .log-date{color:#888; font-size:0.75rem;}
        .log-msg{color:#2ecc71; font-weight:bold; margin-top:3px;}
        #toast {visibility: hidden; min-width: 280px; color: #fff; text-align: center; border-radius: 12px; padding: 18px; position: fixed; z-index: 1000; left: 50%; bottom: 40px; transform: translateX(-50%); box-shadow: 0 8px 20px rgba(0,0,0,0.6); font-weight: bold; font-size: 1.1rem; transition: 0.3s;}
        #toast.show {visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s;}
        .toast-red { background-color: #e74c3c; border: 2px solid #c0392b; }
        .toast-green { background-color: #2ecc71; border: 2px solid #27ae60; color: #141414 !important; }
        @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 40px; opacity: 1;} }
        @keyframes fadeout { from {bottom: 40px; opacity: 1;} to {bottom: 0; opacity: 0;} }
    </style>
</head>
<body>
    <div class="header">
        <span>SAMXI SMART DOOR</span>
        <div class="led-group">
            <div id="wifiSig" class="wifi-box" style="display:none;"> <span id="rssiVal">--</span></div>
            <div id="led" class="led"></div>
            <svg id="gear" class="gear-icon" onclick="document.getElementById('modal').style.display='block'" viewBox="0 0 24 24">
                <path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/>
            </svg>
        </div>
    </div>
    <div class="container">
        <div id="pg1">
            <h2 style="color:#2ecc71;">LOGIN</h2>
            <div id="netStat" class="net-status online-bg">Checking Connection...</div>
            <input type="text" id="id" placeholder="PRODUCT ID" value="SAMXI_12345">
            <button onclick="connect()" class="btn up" style="padding:15px; font-size:1.3rem;">NEXT</button>
        </div>
        <div id="pg2" style="display:none;">
            <div class="status-box">CONNECTED</div>
            <input type="password" id="entryPin" placeholder="ENTER 4-DIGIT PIN" maxlength="4" style="text-align:center; font-size:1.8rem; border:2px solid #f1c40f;">
            <button onclick="verifyPin()" class="btn down" style="color:black; background:#f1c40f;">UNLOCK DOOR</button>
        </div>
        <div id="pg3" style="display:none;">
            <div class="status-box" id="stat"> CHECKING SENSOR... <div class="progress-container" id="pCont"><div class="progress-bar" id="pBar"></div></div> </div>
            <div id="lastUpdate" style="font-size: 0.8rem; color: #888; margin-top: -10px; margin-bottom: 10px;">Last update: --:--</div>
            <button id="m1" class="btn up" onclick="cmd('up', 'OPEN GATE')">OPEN DOOR</button>
            <button id="m2" class="btn stop" onclick="cmd('stop', 'STOP GATE')">STOP</button>
            <button id="m3" class="btn down" onclick="cmd('down', 'CLOSE GATE')">CLOSE DOOR</button>
            <button id="abtn" class="btn auto" onclick="startAuto()">AUTO CLOSE</button>
            <button id="hbtn" class="btn hist-btn" onclick="openHistory()">VIEW ACTIVITY HISTORY</button>
        </div>
    </div>
    <div id="modal">
        <div class="modal-content">
            <h2 style="color:#2ecc71; margin-top:0;">SETTINGS</h2>
            <label>Auto Close:</label>
            <select id="ae" onchange="save()">
                <option value="1">ENABLED</option>
                <option value="0">DISABLED</option>
            </select>
            <label>Timer (sec):</label>
            <input type="number" id="at" onfocus="timerEditing=true" oninput="timerEditing=true">
            <hr style="border:0; border-top:1px solid #333; margin:15px 0;">
            <label>Update PIN:</label>
            <input type="password" id="newPin" placeholder="4 Digits" maxlength="4">
            <button onclick="changePin()" style="width:100%;background:#f1c40f;padding:15px;border:none;border-radius:8px;font-weight:bold;margin-bottom:10px;cursor:pointer;">SET NEW PIN</button>
            <button onclick="save()" style="width:100%;background:#2ecc71;padding:15px;border:none;border-radius:8px;font-weight:bold;color:black;margin-top:10px;cursor:pointer;">SAVE SETTINGS</button>
            <button onclick="factoryReset()" style="width:100%;background:#e74c3c;padding:15px;border:none;border-radius:8px;margin-top:15px;color:white;font-weight:bold;cursor:pointer;">FACTORY RESET</button>
            <button onclick="document.getElementById('modal').style.display='none'" class="exit-link">EXIT</button>
        </div>
    </div>
<div id="hModal">
    <div class="modal-content">
        <h2 style="color:#2ecc71; margin-top:0;">ACTIVITY HISTORY</h2>
        <ul id="logList"></ul>
        <hr style="border:0; border-top:1px solid #333; margin:20px 0;">
        <button onclick="fetchSecurityLogs()" style="width:100%; background:#d9534f; color:white; padding:15px; border:none; border-radius:12px; font-weight:bold; cursor:pointer;">UN-AUTHORIZED LOG</button>
        <div id="securityLogDisplay" style="margin-top:15px; max-height:250px; overflow-y:auto; font-size: 0.9rem;"></div>
        <button onclick="clearHistory()" style="width:100%;background:#444;padding:10px;border:none;border-radius:8px;margin-top:20px;color:white;cursor:pointer;">CLEAR LOGS</button>
        <button onclick="document.getElementById('hModal').style.display='none'" class="exit-link">EXIT</button>
    </div>
</div>
   
    <div id="toast"></div>
    <script>
        let wakeLock = null;
        let client, dev, currentWait = 10, countdownTimer, lastMsgTime = Date.now();
        let timerEditing = false, isCountingDown = false, isStatusLocked = false;
        let lastSensorStatus = "OFFLINE";
        let gateReminderTimer = null, reminderInterval = 5 * 60 * 1000;
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

        async function requestWakeLock() {
            try { if ('wakeLock' in navigator) { wakeLock = await navigator.wakeLock.request('screen'); } } catch (err) {}
        }

        document.addEventListener('visibilitychange', async () => {
            if (document.visibilityState === 'visible') {
                await requestWakeLock();
                lastMsgTime = Date.now();
                if (!client || !client.isConnected()) { connect(); } else { send("PING"); }
            }
        });

        function showToast(message, type) {
            const x = document.getElementById("toast");
            x.innerText = message;
            x.className = "show " + (type === 'error' ? 'toast-red' : 'toast-green');
            setTimeout(function(){ x.className = ""; }, 3000);
        }

        function vibrateAlert(type) {
            if ("vibrate" in navigator) {
                type === 'opening' ? navigator.vibrate([500, 100, 500]) : navigator.vibrate(200);
            }
        }

        function startGateReminder() {
            if (gateReminderTimer) return;
            gateReminderTimer = setInterval(() => {
                const s = document.getElementById('stat');
                s.innerHTML = "ATTENTION GATE IS OPEN" + document.getElementById('pCont').outerHTML;
                s.classList.add("alert-active");
                playAlertBeeps();
                showToast("REMINDER: Gate is still open!", "error");
            }, reminderInterval);
        }

        function stopGateReminder() {
            if (gateReminderTimer) { clearInterval(gateReminderTimer); gateReminderTimer = null; }
            document.getElementById('stat').classList.remove("alert-active");
            document.getElementById('stat').style.backgroundColor = "";
        }

        function addLog(msg) {
            const now = new Date();
            const dateStr = now.toLocaleDateString(undefined, {month:'short', day:'numeric', year:'numeric'});
            const timeStr = now.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
            let logs = JSON.parse(localStorage.getItem("samxi_logs") || "[]");
            logs.unshift({ date: dateStr + " " + timeStr, msg: msg });
            if(logs.length > 50) logs.pop();
            localStorage.setItem("samxi_logs", JSON.stringify(logs));
        }

        function openHistory() {
            const list = document.getElementById('logList');
            let logs = JSON.parse(localStorage.getItem("samxi_logs") || "[]");
            list.innerHTML = logs.length ? logs.map(l => {
                let clr = l.msg.includes("Detected") ? "color:#FFFF00;" : "color:#2ecc71;";
                return `<li class="log-item"><span class="log-date">${l.date}</span><span class="log-msg" style="${clr}">${l.msg}</span></li>`;
            }).join('') : '<li style="text-align:center;color:#666;">No activity found</li>';
            document.getElementById('hModal').style.display = 'block';
        }

        function clearHistory() { localStorage.setItem("samxi_logs", "[]"); openHistory(); }

        function cmd(type, logMsg) {
            if(isCountingDown && type !== 'auto') return;
            let displayTxt = "WORKING...";
            if(type === 'up') displayTxt = "OPENING...";
            if(type === 'down') displayTxt = "CLOSING...";
            if(type === 'stop') displayTxt = "STOPPED";
           
            // Removed artificially long 8-second delay logic
            const s = document.getElementById('stat');
            s.innerHTML = displayTxt + document.getElementById('pCont').outerHTML;

            addLog(logMsg);
            send(type);
        }

        function updateNetStat() {
            const ns = document.getElementById('netStat');
            ns.style.display = 'block';
            if(navigator.onLine) {
                ns.innerText = "Phone Online - Connecting to Server...";
                ns.className = "net-status online-bg";
            } else {
                ns.innerText = "No Internet Connection";
                ns.className = "net-status offline-bg";
            }
        }

        window.addEventListener('online', updateNetStat);
        window.addEventListener('offline', updateNetStat);

        window.onload = function() {
            updateNetStat();
            let savedID = localStorage.getItem("samxi_id");
            if(savedID) {
                document.getElementById('id').value = savedID;
            }
            if(localStorage.getItem("samxi_pin")) document.getElementById('entryPin').value = localStorage.getItem("samxi_pin");
        };

        function playBeep(f, d) {
            try {
                const o = audioCtx.createOscillator();
                const g = audioCtx.createGain();
                o.connect(g); g.connect(audioCtx.destination);
                o.frequency.value = f; o.start();
                g.gain.exponentialRampToValueAtTime(0.00001, audioCtx.currentTime + d);
                o.stop(audioCtx.currentTime + d);
            } catch(e){}
        }

        function playAlertBeeps() {
            let count = 0;
            let interval = setInterval(() => {
                playBeep(1800, 0.3); count++;
                if (count >= 6) clearInterval(interval);
            }, 1000);
        }

        function freezePanel(status, forceAll = false) {
            const btns = document.querySelectorAll('#pg3 .btn');
            btns.forEach(btn => {
                if (forceAll) {
                    if (status) btn.classList.add('timer-lock');
                    else btn.classList.remove('timer-lock');
                    return;
                }
                if (btn.id === 'abtn') { btn.classList.remove('timer-lock'); return; }
                if(status) btn.classList.add('timer-lock');
                else btn.classList.remove('timer-lock');
            });
        }

        setInterval(() => {
            if (document.getElementById('pg3').style.display === 'block') {
                const timeDiff = Date.now() - lastMsgTime;
                if (isCountingDown) { document.getElementById('led').className = "led green"; return; }
                if (timeDiff > 20000 || !navigator.onLine) {
                    document.getElementById('led').className = "led red";
                    if(!isStatusLocked) document.getElementById('stat').innerHTML = "OFFLINE" + document.getElementById('pCont').outerHTML;
                    freezePanel(true, true);
                    if (client && !client.isConnected()) connect();
                }
            }
        }, 1000);

        function showProgress(duration) {
            const cont = document.getElementById('pCont');
            const bar = document.getElementById('pBar');
            cont.style.display = 'block'; bar.style.transition = 'none'; bar.style.width = '0%';
            setTimeout(() => { bar.style.transition = `width ${duration}s linear`; bar.style.width = '100%'; }, 50);
        }

        function hideProgress() { document.getElementById('pCont').style.display = 'none'; }

        function updateWiFi(rssi) {
            const box = document.getElementById('wifiSig');
            const val = document.getElementById('rssiVal');
            box.style.display = 'flex';
            const r = parseInt(rssi);
            let statusText = "";
            if (r >= -50) { statusText = "EXTREME"; box.className = "wifi-box sig-excellent"; }
            else if (r >= -60) { statusText = "BEST"; box.className = "wifi-box sig-excellent"; }
            else if (r >= -70) { statusText = "GOOD"; box.className = "wifi-box sig-good"; }
            else if (r >= -80) { statusText = "MODERATE"; box.className = "wifi-box sig-good"; }
            else { statusText = "WEAK"; box.className = "wifi-box sig-weak"; }
            val.innerText = statusText + " (" + r + "dBm)";
        }

        function startAuto() {
            if(isCountingDown) return;
            isCountingDown = true;
            let duration = parseInt(currentWait);
            let endTime = Date.now() + (duration * 1000);
            let abtn = document.getElementById('abtn');
            cmd('auto', 'AUTO CLOSE START');
            freezePanel(true, false);
            if(countdownTimer) clearInterval(countdownTimer);
            countdownTimer = setInterval(() => {
                let now = Date.now();
                let timeLeft = Math.round((endTime - now) / 1000);
                lastMsgTime = now;
                document.getElementById('led').className = "led green";
                if (timeLeft > 0) {
                    abtn.innerText = "Auto Closing in " + timeLeft + "s";
                    if(timeLeft <= 3) playBeep(1200, 0.2);
                } else {
                    clearInterval(countdownTimer);
                    abtn.innerText = "AUTO CLOSE"; isCountingDown = false;
                    playBeep(440, 0.5); freezePanel(false, true);
                }
            }, 1000);
        }

    function connect() {
    dev = document.getElementById('id').value.trim();
    localStorage.setItem("samxi_id", dev);
   
    try {
        if (window.OneSignalDeferred) {
            OneSignalDeferred.push(async function(OneSignal) {
                await OneSignal.login(dev);
                await OneSignal.sendTag("device_id", dev);
                console.log("Handshake Complete for: " + dev);
            });
        }
    } catch(e) { console.log("OneSignal Sync Failed"); }


            client = new Paho.MQTT.Client("broker.hivemq.com", 8884, "cl_" + Math.random().toString(16).slice(2,8));


client.onConnectionLost = (e) => {
    if(!isCountingDown) {
        document.getElementById('led').className = "led red";
        document.getElementById('stat').innerHTML = `
            OFFLINE
            <button onclick="connect()" style="margin-top:10px; padding:5px 15px; background:#f1c40f; color:black; border:none; border-radius:5px; font-weight:bold; cursor:pointer;">
                RECONNECT NOW
            </button>
        ` + document.getElementById('pCont').outerHTML;
        freezePanel(true, true);
    }
};
            client.onMessageArrived = (m) => {
                let p = m.payloadString;
                let s = document.getElementById('stat');
                lastMsgTime = Date.now();
                document.getElementById('led').className="led green";
                if(!isCountingDown) freezePanel(false, true);
                const now = new Date();
                document.getElementById('lastUpdate').innerText = "Last sync: " + now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
               
                if (p === "OPENING" || p === "OPEN") {
                    if (lastSensorStatus !== "OPEN") {
                        showToast("ALERT: Door is Opening!", "error");
                        vibrateAlert('opening');
                        addLog("Detected : GateOpened");
                        startGateReminder();
                        alert("SAMXI ALERT: Gate is Opened!"); 
                    }
                    lastSensorStatus = "OPEN";
                    if(!isStatusLocked) {
                        s.innerHTML = "GATE OPENED" + document.getElementById('pCont').outerHTML;
                        s.style.backgroundColor = "#3a1e1e";
                        hideProgress();
                    }
                } else if (p === "CLOSED") {
                    if (lastSensorStatus !== "CLOSED") {
                        showToast("SUCCESS: Door is Closed", "green");
                        vibrateAlert('closed');
                        addLog("Detected : GateClosed");
                        stopGateReminder();
                        alert("SAMXI INFO: Gate is Closed.");
                    }
                    lastSensorStatus = "CLOSED";
                    if(!isStatusLocked) {
                        s.innerHTML = "GATE CLOSED" + document.getElementById('pCont').outerHTML;
                        s.style.backgroundColor = "#1e3a1e";
                        hideProgress();
                    }
                }
                if (p === "OFFLINE" && !isCountingDown) {
                    document.getElementById('led').className = "led red";
                    if(!isStatusLocked) s.innerHTML = "OFFLINE" + document.getElementById('pCont').outerHTML;
                    freezePanel(true, true); return;
                }
                if (p === "PIN_OK") {
                    localStorage.setItem("samxi_pin", document.getElementById('entryPin').value);
                    document.getElementById('pg2').style.display='none';
                    document.getElementById('pg3').style.display='block';
                    document.getElementById('gear').style.visibility='visible';
                    send("GET_STATE");
                } else if (p === "WRONG_PIN") {
                    alert("Wrong PIN!");
                } else if (p === "PIN_CHANGED") {
                    alert("PIN Updated Successfully!"); location.reload();
                } else if (p === "RESET_SUCCESS") {
                    alert("SYSTEM RECOVERY: Factory Reset Complete."); location.reload();
                } else if (p === "ALERT|STILL_OPEN") {
                    if(!isStatusLocked) s.innerHTML = "STILL OPEN!" + document.getElementById('pCont').outerHTML;
                    s.classList.add("alert-active"); playAlertBeeps();
                } else if (p === "ONLINE" || p === "PAUSED" || p.startsWith("DATA|") || p.includes("now")) {
                    document.getElementById('pg1').style.display='none';
                    if(document.getElementById('pg3').style.display !== 'block') document.getElementById('pg2').style.display='block';
                    if(p.startsWith("DATA|")) {
                        let d = p.split("|");
                        updateWiFi(d[1]);
                        if (!timerEditing) { document.getElementById('at').value = d[3]; currentWait = d[3]; }
                        document.getElementById('ae').value = d[2];
                        document.getElementById('abtn').style.display = (d[2]=="1") ? "block" : "none";
                        if(s.innerText.includes("CHECKING") && !isStatusLocked) {
                           if(p.includes("OPEN")) {
                               s.innerHTML = "GATE OPENED" + document.getElementById('pCont').outerHTML;
                               s.style.backgroundColor = "#3a1e1e";
                           }
                           else if(p.includes("CLOSED")) {
                               s.innerHTML = "GATE CLOSED" + document.getElementById('pCont').outerHTML;
                               s.style.backgroundColor = "#1e3a1e";
                           }
                        }
                    } else if (p === "START_AUTO") { startAuto(); }
                    else if (p === "PAUSED") {
                        if(!isStatusLocked) { s.innerHTML = "STOPPED" + document.getElementById('pCont').outerHTML; hideProgress(); }
                    }
                }
            };
            client.connect({
                useSSL:true, keepAliveInterval: 10, timeout: 5,
                onSuccess: () => {
                    client.subscribe("samxi/"+dev+"/state");
                    requestWakeLock();
                    send("GET_STATE");
                    const ns = document.getElementById('netStat');
                    ns.innerText = "System Ready"; ns.className = "net-status online-bg";
                    setTimeout(() => { ns.style.display = 'none'; }, 2000);
                },
                onFailure: () => { setTimeout(connect, 3000); }
            });
        }

        function verifyPin() {
            if(audioCtx.state === 'suspended') audioCtx.resume();
            requestWakeLock();
            send("VERIFY|" + document.getElementById('entryPin').value);
        }

        function changePin() {
            let np = document.getElementById('newPin').value;
            if(np.length<4){alert("4 Digits Required!"); return;}
            send("SETPIN|"+np);
        }

        function save() {
            let timerVal = document.getElementById('at').value;
            let autoVal = document.getElementById('ae').value;
            currentWait = timerVal; timerEditing = false;
            send("CONFIG|" + timerVal + "|" + autoVal);
            alert("Settings Saved!");
        }

        function factoryReset() { if(confirm("Are you sure? This will wipe all settings and restart the device.")) send('RESET_FACTORY'); }

        function send(c) {
            if(client && client.isConnected()){
                let m = new Paho.MQTT.Message(c);
                m.destinationName = "samxi/"+dev+"/cmd";
                client.send(m);
            }
        }

        async function fetchSecurityLogs() {
            const appId = "a71c864f-2514-4798-b919-4511e0801b5a";
            let restKey = localStorage.getItem("samxi_rest_key");

            if (!restKey) {
                restKey = prompt("Please enter your new OneSignal REST API Key:");
                if (restKey) {
                    localStorage.setItem("samxi_rest_key", restKey);
                } else {
                    return; 
                }
            }

            const display = document.getElementById("securityLogDisplay");
            display.innerHTML = "<p style='text-align:center; color:#888;'>Checking System Records...</p>";

            try {
                const response = await fetch(`https://onesignal.com/api/v1/notifications?app_id=${appId}&limit=30`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Basic ${restKey}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.status === 401) {
                    localStorage.removeItem("samxi_rest_key");
                    display.innerHTML = "<p style='text-align:center; color:#ff4d4d;'>Invalid Key. Reload to try again.</p>";
                    return;
                }

                const data = await response.json();
                let html = "";

                if (data.notifications && data.notifications.length > 0) {
                    data.notifications.forEach(notif => {
                        let msg = notif.contents.en;
                        if (msg.includes("still open")) return; 
                        if (msg.includes("via APP")) return; 
                        if (!msg.includes("MANUALLY") && !msg.includes("ALERT")) return;

                        let date = new Date(notif.queued_at * 1000);
                        let timeStr = date.toLocaleString('en-GB', { timeZone: 'Asia/Colombo' });
                       
                        html += `<div style="padding:10px; border-bottom:1px solid #333; background:#222; margin-bottom:5px; border-radius:8px; border-left: 5px solid #ff4d4d;">
                                    <small style="color:#ff4d4d; font-weight:bold;"> UN-AUTHORIZED EVENT</small><br>
                                    <span style="color:#888; font-size:11px;">${timeStr}</span><br>
                                    <strong style="color:#eee;">${msg}</strong>
                                 </div>`;
                    });
                }
                display.innerHTML = html || "<p style='text-align:center; color:#2ecc71;'>No unauthorized events detected.</p>";
            } catch (err) {
                display.innerHTML = "<p style='text-align:center; color:#ff4d4d;'>Connection Error.</p>";
            }
        }
    </script>
</body>
</html>
